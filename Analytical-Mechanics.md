# Analytical-Mechanics
解析力学をプログラミングをしながら学ぶためのリポジトリ

## 第一回(最小作用の原理と変分法)
1. 局所から大域へ
- 運動方程式 $F = ma$ は瞬間に注目する局所的な視点だった．
- 解析力学では「物体は，時刻 $t_{1}~t_{2}$ で移動するとき，作用という物理量が最小になるように経路を選ぶ」と見る．これを最小作用の原理(ハミルトンの原理)と呼ぶ．

2. ラグランジアンと作用
- ラグランジアンLの定義は以下
  - $L(q, \dot q, t)=T-V$ (ただしTは運動エネルギー，Vはポテンシャルエネルギー)

- 作用(S)とは，ラグランジアンを時間で積分したものである．
  - $S[q(t)]=\int_{t_{1}}^{t_{2}}L(q(t), \dot q(t), t)dt$

- 自然界の運動は汎関数(S)の変分 $\delta S$ が $\delta S=0$ を満たすような経路を通る．
  - このことから *オイラーラグランジュ方程式* が導かれる．

### 変分法
- 微分と似た概念ではあるが，極値を考える対称が違う．
  - 微分->関数の極値を考え，変化するのは変数
  - 変分->汎関数の極値を考え，変化するのは関数形

- 今回，Sは汎関数．
  - $S[q(t)]=\int_{t_{1}}^{t_{2}}L(q(t), \dot q(t), t)dt$
  - 積分だから，最後の合計値さえ変わらなければその過程の関数の形が変わってもいいと考える．

3. なぜ $L=T-V$ ？
- $S=\int_{t_{1}}^{t_{2}}(T-V)dt$ を最小化するとは？
  - $\int Tdt$ を小さくする->できるだけゆっくり，最短距離で動きたい．
  - $-\int Vdt$ を小さくする( $\int Vdt$ を大きくしたい)->できるだけポテンシャルが高いところにいたい．
  - この二つの要求の妥協した形が実際の軌道．

### calculus of variation
- 変分をプログラミングで再現する．
- なぜ配列要素数がN+1？
  - 植木算と呼ばれる．
  - 配列を用いて取得したいのは「点」ではなく「区間」だから，始点と終点の情報が必要になる．もし要素数がNだったら，最後のゴール地点のデータが格納できなくなる．

- なぜT_END=1.42877?
  - $y(t)=H-\frac{1}{2}gt^2$ でH=10としたとき，地面に到達する時間は大体これくらいの時間．

- なぜ直線の方程式を $y(t)=H-H(\frac{t}{T_{end}})$ にしたのか？
  - 変形すると $y(t)=H(1-\frac{t}{T_{end}})$ 
  - t=0の時y=H, $t=T_{end}$ の時y=0．
  - $T_{end}$ で割るという操作は時間を正規化する処理．この処理のおかげで，時刻 $T_{end}$ に置いて，ちょうどH分だけ下がりきる直線が表現できる．

- 作用Sの計算関数の実装
  - 本来積分で表されるものを離散化して和に変換する．
  - 隣り合う点i, i+1の間の区間におけるラグランジアンを考える．
1. 速度vの近似
  - 区間の平均速度は $v_{i} \approx \frac{v_{i+1}-v_{i}}{dt}$ 
  - $T = \frac{1}{2}m(\frac{v_{i+1}-v_{i}}{dt})^2$
2. 高さhの平均をとる $h_{mean} = \frac{y_{i+1}+y_{i}}{2}$
  - $V = mg(\frac{y_{i+1}+y_{i}}{2})$
3. 部分作用 $S_{i}$
  - ラグランジアンに時間幅dtを掛ける(積分の近似)
  - $S_{i}=(T-V)dt$
  - whileでi=0からN-1まで回してsumに足しこんでいく．Nまで回すとi+1であふれるから注意．

- 局所性
  - ある点 $y_{i}$ はその直前の区間と直後の区間のラグラジアンにしか影響を与えない．これを*局所性*という.
  - ここから，全区間の積分ではなく，局所的な微分方程式で運動を記述できることがわかる．

### オイラーラグランジュ方程式の離散的導出
- 作用Sを $y_{i}$ について偏微分し，その結果を=0とする．
- $m\frac{y_{i+1}-2y_{i}+y_{i-1}}{(\delta t)^2}=-mg$ が導かれる．
- 左辺の  $\frac{y_{i+1}-2y_{i}+y_{i-1}}{(\delta t)^2}$ は加速度の離散近似になっている．
- 運動方程式ma=Fが作用最小の原理から自動的に導かれた．

## 第二回: 一般化座標とオイラーラグランジュ方程式
- ニュートン力学では極座標や回転座標系を使うと，遠心力やコリオリ力などの「見かけの力」を考えなければいけなかった．
- 解析力学ではラグランジアン $L(q, \dot q)$ さえわかれば機械的に正しい運動方程式が得られる．
- 一般化座標とは
  - 系の状態を一意に決定するために必要な，最小限の独立なパラメータ群のこと．
  1. 拘束(Constraints)を探す
    - 例えば振子なら，x, yと二つのパラメータがあるが，紐の長さlによって拘束が一つある->自由度=2-1=1->変数は一つでいい．
  2. 計算が楽になる変数を選ぼう
    - 1.の例を使うと，例えば変数にxも選べるが， $y=±\sqrt{l^2 - x^2}$ となり，計算が大変．θを選べば， $x=lsin\theta, y=l-lcos\theta$ となり，θがどんな値でも拘束条件は満たされる．


### 形式化
- 一般化座標を $q_{k}(k=1, ..., n)$ とすれば，オイラーラグランジュ方程式は以下．
- $\frac{d}{dt}(\frac{\partial L}{\partial \dot q_{k}})-\frac{\partial L}{\partial q_{k}}=0$ ただし，kの数だけ方程式が立つ．

- 単振子(pendulum)
1. 座標: 角度θを一般化座標qとする．
2. 速度: 質点の速度 $v = l \dot \theta$
3. 高さ: 最下点を基準にすると $h=l-lcos\theta$
4. $T=\frac{1}{2}m(l\dot \theta)^2$
5. $V=mg(l-lcos\theta)$
6. $L-T-v$ に4, 5の結果を代入する．
7. E-L方程式を解く
8. $\ddot \theta = -\frac{g}{l}sin\theta$ が得られる．
  - 得られた非線形微分方程式をどう解こう？

### 4次ルンゲクッタ法(RK4)
- 微分方程式を数値的に積分する．
1. 準備: 数値計算では2階微分方程式を直接扱えないので，変数を増やして1階に落とす．
  - $\dot \theta = \omega, \dot \omega = -\frac{g}{l}sin\theta$
  - 一般形 $\frac{dy}{dt}=f(t, y)$ で書けば，状態ベクトル $y=[\theta, \omega]$ ,関数 $f(y)=[\omega, -\frac{g}{l}sin\theta]$

2. θとωの情報を持つ構造体Stateを定義する．
3. 微分の計算関数`Strate func(double t, State s)`を定義する．
  - 入力: 現在の時刻t, 現在の状態 $s(\theta, \omega)$
  - 出力: その瞬間の変化率 $\frac{ds}{dt}(\dot \theta, \dot \omega)$
  - 中身: 返り値の`.theta`には`s.omega`を，`.omega`には`-(G/L)*sin(s.theta)`を入れて返す．

4. RK4ステップ関数`State rk4_step(double t, State current, double dt)`
  - RK4の公式通りにk1, k2, k3, k4を計算して，次の状態を返す．
  - ベクトル演算はC言語にはないから，`theta`と`omega`は個別に計算しないといけない．

### 位相空間(Phase Space)を描こう
- 縦軸に速度 $\dot q$ (今回omega)，横軸に位置 $q$ (今回theta)を取ったグラフ．
- エネルギーが保存されているならその軌道は閉じた円(楕円)になるはず．
![RK4の実行結果と位相空間](images/phase_space.png)

### 消えた拘束力の考慮
- ラグランジアンLを設定したとき，拘束力は無視された．今回ならば張力S．この情報がほしいときはどうしよう？
  - 運動方程式を拘束力方向に書き直せばいい．
  - 結果は以下の様になる．
![tension](images/tension.png)

## 第3回: ハミルトニアンと正準方程式
- ラグランジュ形式では変数が位置 $q$ と速度 $\dot q$ だったが，速度というのは扱いにくい．
1. より本質的な物理量である一般化運動量 $p$ を導入しよう．
  - 定義: $p_{i}\equiv \frac{\partial L}{\partial \dot q_{i}}$
  - 単振子の時 $L=\frac{1}{2}ml^2 \dot \theta^2 - mgl(1-cos\theta)$ であるから $p_{\theta}=\frac{\partial L}{\partial \dot \theta}=ml^2 \dot \theta$ であり，角運動量を表している．

2. ラグランジアン $L(q, \dot q)$ を，変数 $(q, p)$ を持つハミルトニアン $H(q, p)$ に変換する．
  - この操作をルジャンドル変換という．
  - $H(q, p)=\sum_{i}p_{i} \dot q_{i} - L(q, \dot q)$ (iは自由度)
  - 左辺の $\dot q$ は全て $p$ を使って書き換えなければいけない．
  - 自由度が寄与する影響を全て足し合わせなければいけない．<-Hはエネルギーでありスカラーだから．

3. ハミルトンの正準方程式
  - オイラーラグランジュ方程式(2階線形微分方程式が1つ)の代わりに，ハミルトン形式では1階の連立微分方程式が2つ現れる．これを正準方程式(Canonical Equation)と呼ぶ．
```math
\begin{equation}
\left\{ \,
  \begin{aligned}
  & \dot q = \frac{\partial H}{\partial p} \\
  & \dot p = -\frac{\partial H}{\partial q} 
  \end{aligned}
\right.
\end{equation}
```
- このように符号が対になっている構造をシンプレクティック構造といい，エネルギー保存やリウヴィルの定理(位相空間の体積を変えない)を支えている．

### 単振子のハミルトニアン導出
1. 単振子のラグランジアンから，一般化運動量は $p_{\theta}=ml^2\theta ^2$i
2. 1より $\dot \theta = \frac{p_{\theta}}{ml^2}$
3. $H(q, p)=p_{\theta}\dot \theta - L(\theta, \dot \theta)$ にそれぞれ代入して $\dot q$ を消す．
4. $H = \frac{1}{2}\frac{p_{\theta}^2}{ml^2} + mgl(1-cos\theta)$
5. 正準形式で表すと，
```math
\begin{equation}
\left\{ \,
  \begin{aligned}
  & \dot \theta = \frac{p_{\theta}}{ml^2} \\
  & \dot p_{\theta} = -mglsin\theta 
  \end{aligned}
\right.
\end{equation}
```
### シンプレクティック積分の実装
- シンプレクティックオイラー法
  - 通常のオイラー法とは違い，更新されたばかりの新しい値を計算に使う．
1. 運動量の更新: 現在の位置 $\theta_{n}$ を使って，次の運動量 $p_{n+1}$ を計算する．
```math
p_{n+1} = p_{n} + \dot p(\theta_{n})\Delta t = p_{n} - (mglsin\theta_{n})\Delta t
```
2. 位置の更新: 今計算したばかりの $p_{n+1}$ を使って，次の位置 $\theta_{n+1}$ を計算する．
```math
\theta_{n+1} = \theta_{n} + \dot \theta(p_{n+1})\Delta t = \theta_{n} + \frac{p_{n+1}}{ml^2}\Delta t
```
- RK4とシンプレクティック法の違い
  - RK4: 次の一歩を正確に．局所的な誤差を限りなく小さくできる，が，時間を進めるほど誤差は大きくなっていく．
  - シンプレクティック法: 一歩の精度は低いが，超えてはいけないライン(幾何的構造を壊してしまうような)を永遠に守る．リウヴィルの定理という幾何的な性質がアルゴリズムに含まれる．

## 第4回: カオスと二重振子
- ラグランジュ形式を使おう．
1. 変数を $(\theta_{1}, \theta_{2}, \dot \theta_{1}, \dot \theta_{2})$ とする．
2. 一つ目の質点の位置を $(x_{1}, y_{1})$ ，二つ目の質点の位置を $(x_{2}, y_{2})$ とすれば，
```math
\begin{equation}
\left\{ \,
  \begin{aligned}
  & x_{1} = l_{1}sin\theta_{1}\\
  & y_{1} = -l_{1}cos\theta_{1}\\
  & x_{2} = l_{1}sin\theta_{1} + l_{2}sin\theta_{2}\\
  & y_{2} = -l_{1}cos\theta_{1} - l_{2}cos\theta_{2}\\
  & \dot x_{1} = \dot \theta_{1}l_{1}cos\theta{1}\\
  & \dot y_{1} = \dot \theta_{1}l_{1}sin\theta{1}\\
  & \dot x_{2} = \dot \theta_{1}l_{1}cos\theta{1} + \dot \theta_{2}l_{2}cos\theta{2}\\
  & \dot y_{2} = \dot \theta_{1}l_{1}sin\theta{1} + \dot \theta_{2}l_{2}sin\theta{2}
  \end{aligned}
\right.
\end{equation}
```
3. ラグランジアンLを求めると，
```math
L = \frac{1}{2}(m_{1}+m_{2})\dot \theta_{1}^2 l_{1}^2 + \frac{1}{2}m_{2}\dot \theta_{2}^2 l_{2}^2 + m_{2}\dot \theta_{1}\dot \theta_{2} l_{1} l_{2} cos(\theta_{1}-\theta_{2}) + (m_{1}+m_{2})gl_{1}cos\theta_{1} + m_{2}gl_{2}cos\theta_{2}
```
4. $\ddot \theta_{1}, \ddot \theta_{2}$ について解く
```math
変数定義: \delta=\theta_{1}-\theta_{2}, M = 2m_{1} + m_{2} 
```
```math
Num_{1} = -g(M)sin\theta_{1} - m_{2}gsin(\theta_{1}-2\theta_{2})-2sin\delta * m_{2}(\dot \theta_{2}^2 l_{2} + \dot \theta_{1}^2 l_{1}cos\delta) 
```
```math
Den_{1} = l_{1}(M - m_{2}cos(2\delta)) 
```
```math
\ddot \theta_{1} = \frac{Num_{1}}{Den_{1}} 
```
```math
Num_{2} = 2sin\delta(\dot \theta_{1}^2 l_{1}(m_{1}+m_{2})+g(m_{1}+m_{2})cos\theta_{1}+\dot \theta_{2}^2 l_{2}m_{2}cos\delta) 
```
```math
Den_{2} = l_{2}(M-m_{2}cos(2\delta)) 
```
```math
\ddot \theta_{2} = \frac{Num_{2}}{Den_{2}}
```
- これをプログラミングで再現すればよい．RK4を用いた．
### 二つの二重振子の距離と軌道．
- 二つの二重振子の初期位置は，互いに0.0001radだけ異なる．
![二重振子の距離](images/chaos_divergence.png)
- 縦軸が対数になっている．ズレが指数関数的 $e^{\lambda t}$ に増大しているだろうか．傾きλが予測の限界を示す「リアプノフ指数」．
![二重振子の軌跡](images/trajectory.png)
- 二重振子の軌跡．初期位置がわずかにずれるだけで予測は困難になる．
